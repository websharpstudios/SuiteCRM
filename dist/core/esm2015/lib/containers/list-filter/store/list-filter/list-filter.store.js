import { Injectable } from '@angular/core';
import { emptyObject, isVoid } from 'common';
import { take, tap } from 'rxjs/operators';
import { BehaviorSubject, combineLatest } from 'rxjs';
import { MessageService } from '../../../../services/message/message.service';
import { SaveFilterStoreFactory } from '../saved-filter/saved-filter.store.factory';
export class ListFilterStore {
    constructor(message, savedFilterStoreFactory) {
        this.message = message;
        this.savedFilterStoreFactory = savedFilterStoreFactory;
        this.panelMode = 'closable';
        this.mode = 'filter';
        this.gridButtons = null;
        this.fields = [];
        this.special = [];
        this.savedFilters = [];
        this.subs = [];
        this.filterStore = savedFilterStoreFactory.create();
    }
    init(config) {
        this.config = config;
        this.initSearchFields();
        this.initConfigUpdatesSubscription();
        this.vm$ = combineLatest([this.filterStore.stagingRecord$]).pipe(tap(([savedFilter]) => {
            this.reset();
            this.splitCriteriaFields(savedFilter);
            this.initDisplayFields();
            this.initGridButtons();
            this.initHeaderButtons();
            this.initMyFiltersButton(this.savedFilters);
        }));
        if (this.config.panelMode) {
            this.panelMode = this.config.panelMode;
        }
        this.collapse = new BehaviorSubject(false);
        this.isCollapsed$ = this.collapse.asObservable();
        if (!isVoid(this.config.isCollapsed)) {
            this.collapse.next(this.config.isCollapsed);
        }
        this.reset();
        this.initGridButtons();
        this.initHeaderButtons();
    }
    clear() {
        this.subs.forEach(sub => sub.unsubscribe());
        this.reset();
        this.filterStore.clear();
        this.filterStore = null;
        this.collapse.unsubscribe();
    }
    clearAuthBased() {
        this.clear();
    }
    /**
     * Reset criteria
     */
    reset() {
        this.fields = [];
        this.special = [];
    }
    /**
     * Apply current filter values
     */
    applyFilter() {
        this.filterStore.validateCriteria().pipe(take(1)).subscribe(valid => {
            if (valid) {
                if (this.config.panelMode === 'collapsible' && this.config.collapseOnSearch) {
                    this.collapse.next(true);
                }
                this.config.onSearch();
                this.config.updateFilter(this.filterStore.getBaseRecord());
                return;
            }
            this.message.addWarningMessageByKey('LBL_VALIDATION_ERRORS');
        });
    }
    /**
     * Clear the current filter
     */
    clearFilter() {
        this.config.resetFilter(false);
    }
    /**
     * Subscribe to config updates.
     * Each time the filter or metadata changes we need to:
     * - Reset the view state
     * - Re-initialize the filter subscription
     */
    initConfigUpdatesSubscription() {
        this.subs.push(combineLatest([this.config.filter$, this.config.searchFields$]).pipe(tap(([filter, searchFields]) => {
            this.reset();
            this.filterStore.initRecord(this.config.module, filter, searchFields, this.config.listFields, 'edit');
        })).subscribe());
        this.subs.push(combineLatest([this.config.savedFilters$]).pipe(tap(([filters]) => {
            this.savedFilters = filters;
            this.initMyFiltersButton(filters);
        })).subscribe());
    }
    /**
     * Split fields per slots
     *
     * @param {object} savedFilter to use
     */
    splitCriteriaFields(savedFilter) {
        if (!savedFilter || !savedFilter.criteriaFields) {
            return;
        }
        Object.keys(savedFilter.criteriaFields).forEach(key => {
            const field = savedFilter.criteriaFields[key];
            const name = field.name || key;
            if (name.includes('_only')) {
                this.special.push(field);
            }
            else {
                this.fields.push(field);
            }
        });
    }
    initSearchFields() {
        this.subs.push(this.config.searchFields$.subscribe(searchFields => {
            this.searchFields = searchFields;
        }));
    }
    initDisplayFields() {
        if (!this.searchFields || emptyObject(this.searchFields) || !this.fields) {
            this.displayFields = [];
        }
        const fields = [];
        this.fields.forEach(field => {
            const name = field.name;
            if (!this.searchFields[name]) {
                return;
            }
            fields.push(field);
        });
        this.displayFields = fields;
    }
    /**
     * Initialize grid buttons
     */
    initGridButtons() {
        this.gridButtons = [
            {
                labelKey: 'LBL_CLEAR_BUTTON_LABEL',
                klass: ['clear-filters-button', 'btn', 'btn-outline-danger', 'btn-sm'],
                onClick: this.clearFilter.bind(this)
            },
            {
                labelKey: 'LBL_SEARCH_BUTTON_LABEL',
                klass: ['filter-button', 'btn', 'btn-danger', 'btn-sm'],
                onClick: this.applyFilter.bind(this)
            }
        ];
    }
    /**
     * Initialize header buttons
     */
    initHeaderButtons() {
        this.closeButton = {
            onClick: () => {
                this.config.onClose();
            }
        };
    }
    initMyFiltersButton(filters) {
        if (!filters || filters.length < 1) {
            this.myFilterButton = null;
            return;
        }
        const button = {
            wrapperKlass: ['filter-select'],
            labelKey: 'LBL_SAVED_FILTER_SHORTCUT',
            klass: ['btn', 'btn-outline-light', 'btn-sm'],
            items: [],
        };
        const currentKey = this.filterStore.getRecordId();
        filters.forEach(filter => {
            const item = {
                label: filter.attributes.name,
                onClick: () => {
                    this.config.setOpenFilter(filter);
                }
            };
            if (filter.key === currentKey) {
                button.label = filter.attributes.name;
                button.labelKey = '';
                item.icon = 'filter';
                item.iconKlass = 'small';
                item.klass = 'active';
            }
            button.items.push(item);
        });
        this.myFilterButton = button;
    }
}
ListFilterStore.decorators = [
    { type: Injectable }
];
ListFilterStore.ctorParameters = () => [
    { type: MessageService },
    { type: SaveFilterStoreFactory }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC1maWx0ZXIuc3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9jb3JlL2FwcC9jb3JlL3NyYy9saWIvY29udGFpbmVycy9saXN0LWZpbHRlci9zdG9yZS9saXN0LWZpbHRlci9saXN0LWZpbHRlci5zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRXpDLE9BQU8sRUFBMkMsV0FBVyxFQUFTLE1BQU0sRUFBcUIsTUFBTSxRQUFRLENBQUM7QUFDaEgsT0FBTyxFQUFDLElBQUksRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6QyxPQUFPLEVBQUMsZUFBZSxFQUFFLGFBQWEsRUFBMkIsTUFBTSxNQUFNLENBQUM7QUFFOUUsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDhDQUE4QyxDQUFDO0FBQzVFLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLDRDQUE0QyxDQUFDO0FBS2xGLE1BQU0sT0FBTyxlQUFlO0lBMEJ4QixZQUNjLE9BQXVCLEVBQ3ZCLHVCQUErQztRQUQvQyxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUN2Qiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXdCO1FBekI3RCxjQUFTLEdBQXdDLFVBQVUsQ0FBQztRQUM1RCxTQUFJLEdBQUcsUUFBUSxDQUFDO1FBT2hCLGdCQUFXLEdBQXNCLElBQUksQ0FBQztRQUV0QyxXQUFNLEdBQVksRUFBRSxDQUFDO1FBQ3JCLFlBQU8sR0FBWSxFQUFFLENBQUM7UUFLdEIsaUJBQVksR0FBa0IsRUFBRSxDQUFDO1FBS3ZCLFNBQUksR0FBbUIsRUFBRSxDQUFDO1FBTWhDLElBQUksQ0FBQyxXQUFXLEdBQUcsdUJBQXVCLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDeEQsQ0FBQztJQUdELElBQUksQ0FBQyxNQUFvQjtRQUNyQixJQUFJLENBQUMsTUFBTSxHQUFH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O1lBQzdDLEtBQUssRUFBRSxFQUFFO1NBQ2UsQ0FBQztRQUU3QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRWxELE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckIsTUFBTSxJQUFJLEdBQUc7Z0JBQ1QsS0FBSyxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSTtnQkFDN0IsT0FBTyxFQUFFLEdBQUcsRUFBRTtvQkFDVixJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDdEMsQ0FBQzthQUNlLENBQUM7WUFFckIsSUFBSSxNQUFNLENBQUMsR0FBRyxLQUFLLFVBQVUsRUFBRTtnQkFDM0IsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztnQkFDdEMsTUFBTSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO2dCQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQztnQkFDekIsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUM7YUFDekI7WUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUFDO0lBQ2pDLENBQUM7OztZQXpRSixVQUFVOzs7WUFMSCxjQUFjO1lBQ2Qsc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7U3RhdGVTdG9yZX0gZnJvbSAnLi4vLi4vLi4vLi4vc3RvcmUvc3RhdGUnO1xuaW1wb3J0IHtCdXR0b25JbnRlcmZhY2UsIERyb3Bkb3duQnV0dG9uSW50ZXJmYWNlLCBlbXB0eU9iamVjdCwgRmllbGQsIGlzVm9pZCwgU2VhcmNoTWV0YUZpZWxkTWFwfSBmcm9tICdjb21tb24nO1xuaW1wb3J0IHt0YWtlLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7QmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtGaWx0ZXJDb25maWd9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvbGlzdC1maWx0ZXIvbGlzdC1maWx0ZXIubW9kZWwnO1xuaW1wb3J0IHtNZXNzYWdlU2VydmljZX0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvbWVzc2FnZS9tZXNzYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHtTYXZlRmlsdGVyU3RvcmVGYWN0b3J5fSBmcm9tICcuLi9zYXZlZC1maWx0ZXIvc2F2ZWQtZmlsdGVyLnN0b3JlLmZhY3RvcnknO1xuaW1wb3J0IHtTYXZlZEZpbHRlclN0b3JlfSBmcm9tICcuLi9zYXZlZC1maWx0ZXIvc2F2ZWQtZmlsdGVyLnN0b3JlJztcbmltcG9ydCB7U2F2ZWRGaWx0ZXJ9IGZyb20gJy4uLy4uLy4uLy4uL3N0b3JlL3NhdmVkLWZpbHRlcnMvc2F2ZWQtZmlsdGVyLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIExpc3RGaWx0ZXJTdG9yZSBpbXBsZW1lbnRzIFN0YXRlU3RvcmUge1xuXG4gICAgY29uZmlnOiBGaWx0ZXJDb25maWc7XG4gICAgcGFuZWxNb2RlOiAnY29sbGFwc2libGUnIHwgJ2Nsb3NhYmxlJyB8ICdub25lJyA9ICdjbG9zYWJsZSc7XG4gICAgbW9kZSA9ICdmaWx0ZXInO1xuXG4gICAgaXNDb2xsYXBzZWQkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuXG4gICAgY2xvc2VCdXR0b246IEJ1dHRvbkludGVyZmFjZTtcbiAgICBteUZpbHRlckJ1dHRvbjogRHJvcGRvd25CdXR0b25JbnRlcmZhY2U7XG5cbiAgICBncmlkQnV0dG9uczogQnV0dG9uSW50ZXJmYWNlW10gPSBudWxsO1xuXG4gICAgZmllbGRzOiBGaWVsZFtdID0gW107XG4gICAgc3BlY2lhbDogRmllbGRbXSA9IFtdO1xuXG4gICAgdm0kOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgICBmaWx0ZXJTdG9yZTogU2F2ZWRGaWx0ZXJTdG9yZTtcbiAgICBzYXZlZEZpbHRlcnM6IFNhdmVkRmlsdGVyW10gPSBbXTtcbiAgICBkaXNwbGF5RmllbGRzOiBGaWVsZFtdO1xuXG4gICAgcHJvdGVjdGVkIGNvbGxhcHNlOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj47XG4gICAgcHJvdGVjdGVkIHNlYXJjaEZpZWxkczogU2VhcmNoTWV0YUZpZWxkTWFwO1xuICAgIHByb3RlY3RlZCBzdWJzOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBtZXNzYWdlOiBNZXNzYWdlU2VydmljZSxcbiAgICAgICAgcHJvdGVjdGVkIHNhdmVkRmlsdGVyU3RvcmVGYWN0b3J5OiBTYXZlRmlsdGVyU3RvcmVGYWN0b3J5XG4gICAgKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyU3RvcmUgPSBzYXZlZEZpbHRlclN0b3JlRmFjdG9yeS5jcmVhdGUoKTtcbiAgICB9XG5cblxuICAgIGluaXQoY29uZmlnOiBGaWx0ZXJDb25maWcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgdGhpcy5pbml0U2VhcmNoRmllbGRzKCk7XG5cbiAgICAgICAgdGhpcy5pbml0Q29uZmlnVXBkYXRlc1N1YnNjcmlwdGlvbigpO1xuXG4gICAgICAgIHRoaXMudm0kID0gY29tYmluZUxhdGVzdChbdGhpcy5maWx0ZXJTdG9yZS5zdGFnaW5nUmVjb3JkJF0pLnBpcGUoXG4gICAgICAgICAgICB0YXAoKFtzYXZlZEZpbHRlcl0pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5zcGxpdENyaXRlcmlhRmllbGRzKHNhdmVkRmlsdGVyKTtcbiAgICAgICAgICAgICAgICB0aGlzLmluaXREaXNwbGF5RmllbGRzKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0R3JpZEJ1dHRvbnMoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmluaXRIZWFkZXJCdXR0b25zKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0TXlGaWx0ZXJzQnV0dG9uKHRoaXMuc2F2ZWRGaWx0ZXJzKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLnBhbmVsTW9kZSkge1xuICAgICAgICAgICAgdGhpcy5wYW5lbE1vZGUgPSB0aGlzLmNvbmZpZy5wYW5lbE1vZGU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbGxhcHNlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XG4gICAgICAgIHRoaXMuaXNDb2xsYXBzZWQkID0gdGhpcy5jb2xsYXBzZS5hc09ic2VydmFibGUoKTtcbiAgICAgICAgaWYgKCFpc1ZvaWQodGhpcy5jb25maWcuaXNDb2xsYXBzZWQpKSB7XG4gICAgICAgICAgICB0aGlzLmNvbGxhcHNlLm5leHQodGhpcy5jb25maWcuaXNDb2xsYXBzZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5yZXNldCgpO1xuXG4gICAgICAgIHRoaXMuaW5pdEdyaWRCdXR0b25zKCk7XG4gICAgICAgIHRoaXMuaW5pdEhlYWRlckJ1dHRvbnMoKTtcbiAgICB9XG5cbiAgICBjbGVhcigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdWJzLmZvckVhY2goc3ViID0+IHN1Yi51bnN1YnNjcmliZSgpKTtcbiAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgICB0aGlzLmZpbHRlclN0b3JlLmNsZWFyKCk7XG4gICAgICAgIHRoaXMuZmlsdGVyU3RvcmUgPSBudWxsO1xuICAgICAgICB0aGlzLmNvbGxhcHNlLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgY2xlYXJBdXRoQmFzZWQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXNldCBjcml0ZXJpYVxuICAgICAqL1xuICAgIHB1YmxpYyByZXNldCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5maWVsZHMgPSBbXTtcbiAgICAgICAgdGhpcy5zcGVjaWFsID0gW107XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQXBwbHkgY3VycmVudCBmaWx0ZXIgdmFsdWVzXG4gICAgICovXG4gICAgcHVibGljIGFwcGx5RmlsdGVyKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmZpbHRlclN0b3JlLnZhbGlkYXRlQ3JpdGVyaWEoKS5waXBlKHRha2UoMSkpLnN1YnNjcmliZSh2YWxpZCA9PiB7XG5cbiAgICAgICAgICAgIGlmICh2YWxpZCkge1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnLnBhbmVsTW9kZSA9PT0gJ2NvbGxhcHNpYmxlJyAmJiB0aGlzLmNvbmZpZy5jb2xsYXBzZU9uU2VhcmNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2UubmV4dCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5vblNlYXJjaCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLnVwZGF0ZUZpbHRlcih0aGlzLmZpbHRlclN0b3JlLmdldEJhc2VSZWNvcmQoKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2UuYWRkV2FybmluZ01lc3NhZ2VCeUtleSgnTEJMX1ZBTElEQVRJT05fRVJST1JTJyk7XG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xlYXIgdGhlIGN1cnJlbnQgZmlsdGVyXG4gICAgICovXG4gICAgcHVibGljIGNsZWFyRmlsdGVyKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNvbmZpZy5yZXNldEZpbHRlcihmYWxzZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlIHRvIGNvbmZpZyB1cGRhdGVzLlxuICAgICAqIEVhY2ggdGltZSB0aGUgZmlsdGVyIG9yIG1ldGFkYXRhIGNoYW5nZXMgd2UgbmVlZCB0bzpcbiAgICAgKiAtIFJlc2V0IHRoZSB2aWV3IHN0YXRlXG4gICAgICogLSBSZS1pbml0aWFsaXplIHRoZSBmaWx0ZXIgc3Vic2NyaXB0aW9uXG4gICAgICovXG4gICAgcHJvdGVjdGVkIGluaXRDb25maWdVcGRhdGVzU3Vic2NyaXB0aW9uKCkge1xuICAgICAgICB0aGlzLnN1YnMucHVzaChcbiAgICAgICAgICAgIGNvbWJpbmVMYXRlc3QoW3RoaXMuY29uZmlnLmZpbHRlciQsIHRoaXMuY29uZmlnLnNlYXJjaEZpZWxkcyRdKS5waXBlKFxuICAgICAgICAgICAgICAgIHRhcCgoW2ZpbHRlciwgc2VhcmNoRmllbGRzXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyU3RvcmUuaW5pdFJlY29yZChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLm1vZHVsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaEZpZWxkcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLmxpc3RGaWVsZHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAnZWRpdCdcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKS5zdWJzY3JpYmUoKVxuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuc3Vicy5wdXNoKFxuICAgICAgICAgICAgY29tYmluZUxhdGVzdChbdGhpcy5jb25maWcuc2F2ZWRGaWx0ZXJzJF0pLnBpcGUoXG4gICAgICAgICAgICAgICAgdGFwKChbZmlsdGVyc10pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlZEZpbHRlcnMgPSBmaWx0ZXJzO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRNeUZpbHRlcnNCdXR0b24oZmlsdGVycyk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTcGxpdCBmaWVsZHMgcGVyIHNsb3RzXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2F2ZWRGaWx0ZXIgdG8gdXNlXG4gICAgICovXG4gICAgcHJvdGVjdGVkIHNwbGl0Q3JpdGVyaWFGaWVsZHMoc2F2ZWRGaWx0ZXI6IFNhdmVkRmlsdGVyKTogdm9pZCB7XG5cbiAgICAgICAgaWYgKCFzYXZlZEZpbHRlciB8fCAhc2F2ZWRGaWx0ZXIuY3JpdGVyaWFGaWVsZHMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIE9iamVjdC5rZXlzKHNhdmVkRmlsdGVyLmNyaXRlcmlhRmllbGRzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IHNhdmVkRmlsdGVyLmNyaXRlcmlhRmllbGRzW2tleV07XG4gICAgICAgICAgICBjb25zdCBuYW1lID0gZmllbGQubmFtZSB8fCBrZXk7XG5cbiAgICAgICAgICAgIGlmIChuYW1lLmluY2x1ZGVzKCdfb25seScpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zcGVjaWFsLnB1c2goZmllbGQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZpZWxkcy5wdXNoKGZpZWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGluaXRTZWFyY2hGaWVsZHMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3Vicy5wdXNoKHRoaXMuY29uZmlnLnNlYXJjaEZpZWxkcyQuc3Vic2NyaWJlKHNlYXJjaEZpZWxkcyA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlYXJjaEZpZWxkcyA9IHNlYXJjaEZpZWxkcztcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpbml0RGlzcGxheUZpZWxkcygpOiB2b2lkIHtcblxuICAgICAgICBpZighdGhpcy5zZWFyY2hGaWVsZHMgfHwgZW1wdHlPYmplY3QodGhpcy5zZWFyY2hGaWVsZHMpIHx8ICF0aGlzLmZpZWxkcyl7XG4gICAgICAgICAgICB0aGlzLmRpc3BsYXlGaWVsZHMgPSBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZpZWxkcyA9IFtdO1xuICAgICAgICB0aGlzLmZpZWxkcy5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBmaWVsZC5uYW1lO1xuICAgICAgICAgICAgaWYoIXRoaXMuc2VhcmNoRmllbGRzW25hbWVdKXtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmaWVsZHMucHVzaChmaWVsZCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZGlzcGxheUZpZWxkcyA9IGZpZWxkcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplIGdyaWQgYnV0dG9uc1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBpbml0R3JpZEJ1dHRvbnMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZ3JpZEJ1dHRvbnMgPSBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbGFiZWxLZXk6ICdMQkxfQ0xFQVJfQlVUVE9OX0xBQkVMJyxcbiAgICAgICAgICAgICAgICBrbGFzczogWydjbGVhci1maWx0ZXJzLWJ1dHRvbicsICdidG4nLCAnYnRuLW91dGxpbmUtZGFuZ2VyJywgJ2J0bi1zbSddLFxuICAgICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMuY2xlYXJGaWx0ZXIuYmluZCh0aGlzKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBsYWJlbEtleTogJ0xCTF9TRUFSQ0hfQlVUVE9OX0xBQkVMJyxcbiAgICAgICAgICAgICAgICBrbGFzczogWydmaWx0ZXItYnV0dG9uJywgJ2J0bicsICdidG4tZGFuZ2VyJywgJ2J0bi1zbSddLFxuICAgICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMuYXBwbHlGaWx0ZXIuYmluZCh0aGlzKVxuICAgICAgICAgICAgfVxuICAgICAgICBdIGFzIEJ1dHRvbkludGVyZmFjZVtdO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgaGVhZGVyIGJ1dHRvbnNcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgaW5pdEhlYWRlckJ1dHRvbnMoKTogdm9pZCB7XG5cbiAgICAgICAgdGhpcy5jbG9zZUJ1dHRvbiA9IHtcbiAgICAgICAgICAgIG9uQ2xpY2s6ICgpOiB2b2lkID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5vbkNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gYXMgQnV0dG9uSW50ZXJmYWNlO1xuXG5cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaW5pdE15RmlsdGVyc0J1dHRvbihmaWx0ZXJzOiBTYXZlZEZpbHRlcltdKTogdm9pZCB7XG5cbiAgICAgICAgaWYoIWZpbHRlcnMgfHwgZmlsdGVycy5sZW5ndGggPCAxKXtcbiAgICAgICAgICAgIHRoaXMubXlGaWx0ZXJCdXR0b24gPSBudWxsO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYnV0dG9uID0ge1xuICAgICAgICAgICAgd3JhcHBlcktsYXNzOiBbJ2ZpbHRlci1zZWxlY3QnXSxcbiAgICAgICAgICAgIGxhYmVsS2V5OiAnTEJMX1NBVkVEX0ZJTFRFUl9TSE9SVENVVCcsXG4gICAgICAgICAgICBrbGFzczogWydidG4nLCAnYnRuLW91dGxpbmUtbGlnaHQnLCAnYnRuLXNtJ10sXG4gICAgICAgICAgICBpdGVtczogW10sXG4gICAgICAgIH0gYXMgRHJvcGRvd25CdXR0b25JbnRlcmZhY2U7XG5cbiAgICAgICAgY29uc3QgY3VycmVudEtleSA9IHRoaXMuZmlsdGVyU3RvcmUuZ2V0UmVjb3JkSWQoKTtcblxuICAgICAgICBmaWx0ZXJzLmZvckVhY2goZmlsdGVyID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB7XG4gICAgICAgICAgICAgICAgbGFiZWw6IGZpbHRlci5hdHRyaWJ1dGVzLm5hbWUsXG4gICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5zZXRPcGVuRmlsdGVyKGZpbHRlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBhcyBCdXR0b25JbnRlcmZhY2U7XG5cbiAgICAgICAgICAgIGlmIChmaWx0ZXIua2V5ID09PSBjdXJyZW50S2V5KSB7XG4gICAgICAgICAgICAgICAgYnV0dG9uLmxhYmVsID0gZmlsdGVyLmF0dHJpYnV0ZXMubmFtZTtcbiAgICAgICAgICAgICAgICBidXR0b24ubGFiZWxLZXkgPSAnJztcbiAgICAgICAgICAgICAgICBpdGVtLmljb24gPSAnZmlsdGVyJztcbiAgICAgICAgICAgICAgICBpdGVtLmljb25LbGFzcyA9ICdzbWFsbCc7XG4gICAgICAgICAgICAgICAgaXRlbS5rbGFzcyA9ICdhY3RpdmUnO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBidXR0b24uaXRlbXMucHVzaChpdGVtKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5teUZpbHRlckJ1dHRvbiA9IGJ1dHRvbjtcbiAgICB9XG59XG4iXX0=